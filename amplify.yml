version: 1

frontend:
  phases:
    preBuild:
      commands:
        # --- Pakai Node 20 di environment build
        - echo "Node before nvm:" && node -v || true
        - if [ -f "$HOME/.nvm/nvm.sh" ]; then . "$HOME/.nvm/nvm.sh"; fi
        - if command -v nvm >/dev/null 2>&1; then nvm install 20 && nvm use 20; fi
        - echo "Using Node:" && node -v && echo "npm:" && npm -v

        # --- Install deps (termasuk devDeps untuk TypeScript)
        - rm -rf node_modules .next .next/cache
        - npm ci --include=dev --no-audit --no-fund

    build:
      commands:
        - export NEXT_TELEMETRY_DISABLED=1
        - export NODE_OPTIONS="--max_old_space_size=4096"

        # --- Validasi env wajib (tanpa print nilai)
        - >
          for k in NEXTAUTH_URL NEXTAUTH_SECRET COGNITO_CLIENT_ID COGNITO_CLIENT_SECRET
          COGNITO_ISSUER BACKEND_BASE NEXT_PUBLIC_API_BASE_URL AUTH_TRUST_HOST; do
            if [ -z "${!k}" ]; then echo "ERROR: Missing env $k"; exit 1; else echo "OK: $k"; fi;
          done

        # --- Tulis env runtime ke .env.production (server & client)
        - echo "Menulis .env.production untuk runtime SSR..."
        - rm -f .env.production
        - printf "NEXTAUTH_URL=%s\n" "$NEXTAUTH_URL" >> .env.production
        - printf "NEXTAUTH_SECRET=%s\n" "$NEXTAUTH_SECRET" >> .env.production
        - printf "COGNITO_CLIENT_ID=%s\n" "$COGNITO_CLIENT_ID" >> .env.production
        - printf "COGNITO_CLIENT_SECRET=%s\n" "$COGNITO_CLIENT_SECRET" >> .env.production
        - printf "COGNITO_ISSUER=%s\n" "$COGNITO_ISSUER" >> .env.production
        - printf "BACKEND_BASE=%s\n" "$BACKEND_BASE" >> .env.production
        - printf "BACKEND_BEARER=%s\n" "$BACKEND_BEARER" >> .env.production
        - printf "NEXT_PUBLIC_API_BASE_URL=%s\n" "$NEXT_PUBLIC_API_BASE_URL" >> .env.production
        - printf "NEXT_PUBLIC_AWS_REGION=%s\n" "$NEXT_PUBLIC_AWS_REGION" >> .env.production
        - printf "AUTH_TRUST_HOST=%s\n" "$AUTH_TRUST_HOST" >> .env.production

        # tampilkan hanya KEY agar aman (tanpa nilai)
        - echo "Keys in .env.production:" && awk -F= '{print $1}' .env.production

        # --- Build Next.js
        - npm run build

  artifacts:
    baseDirectory: .next
    files:
      - "**/*"

  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
