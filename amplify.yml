version: 1
frontend:
  phases:
    preBuild:
      commands:
        # Gunakan Node 20 (harus sebelum semua perintah node/npm)
        - nvm install 20
        - nvm use 20
        - echo "Node $(node -v) | npm $(npm -v)"
        
        # Pastikan lockfile ada
        - test -f package-lock.json || (echo "ERROR: package-lock.json missing" && exit 1)

        # Bersihkan cache lama
        - rm -rf node_modules .next .next/cache

        # Install deps + devDeps
        - npm ci --include=dev

        # Sanity check: pastikan Tailwind tersedia
        - npm ls tailwindcss || true
        - npx tailwindcss -v || (echo "Tailwind not found after npm ci" && exit 1)
        - node -e "require('tailwindcss'); console.log('tailwind ok')"

        # Verifikasi alias path di tsconfig.json
        - node -e "const f=require('./tsconfig.json'); const ok=f?.compilerOptions?.paths?.['@/*']; if(!ok){console.error('ERROR: Alias @ belum dikonfigurasi di tsconfig.json'); process.exit(1)} console.log('Alias @ OK ->', ok)"

    build:
      commands:
        - export NEXT_TELEMETRY_DISABLED=1
        - export NODE_OPTIONS="--max_old_space_size=4096"

        # ENV wajib
        - test -n "$NEXT_PUBLIC_API_BASE_URL" || (echo 'ERROR: NEXT_PUBLIC_API_BASE_URL belum di-set di Amplify' && exit 1)

        # Tulis ENV ke file
        - printf "NEXT_PUBLIC_API_BASE_URL=%s\n" "$NEXT_PUBLIC_API_BASE_URL" > .env.production
        - echo ".env.production:" && cat .env.production

        # Build Next.js
        - npm run build

  artifacts:
    baseDirectory: .next
    files:
      - '**/*'

  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
